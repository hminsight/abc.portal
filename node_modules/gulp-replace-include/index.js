/*!
 * gulp-replace-include
 * https://github.com/sprawld/gulp-replace-include/
 * MIT License
 */
'use strict';

var fs = require('fs'),
	glob = require('glob'),
	through = require('through2'),
	gutil = require('gulp-util'),
	path = require('path'),
	_ = require('lodash');

var plugin = 'gulp-replace-include';

var replaceString = (a,b,c) => a.replace(new RegExp(b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&"),'g'),c.replace(/\$/g,'$$$$'));

module.exports = (opts) => {

	// defaults
	var options = _.extend({
		src: '',
		prefix: '@@',
		include: [],
		global: {},
		pages: {},
	},opts);

	// create Regular Expressions for built in functions (if/endif/include/require)
	var prefix = options.prefix,
		global = options.global,
		include = options.include,
		src = options.src,
		pages = options.pages,
		includeLength = include.length,
		prefixReg = prefix.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&"),
		ifSplit = new RegExp('('+prefixReg+'if\\([^\)]*\\)|'+prefixReg+'endif)','g'),
		ifReg = new RegExp(prefixReg+'if\\(([^\)]*)\\)'),
		endifReg = new RegExp(prefixReg+'endif'),
		includeReg = new RegExp(prefixReg+'include\\(([^\)]*)\\)','g'),
		requireReg = new RegExp(prefixReg+'require\\(([^\)]*)\\)','g'),
		globalCode = _.map(global,(a,b) => 'var '+b+' = '+JSON.stringify(a)+';').join('');

	return through.obj(function(file, enc, cb) {

		// Check file
		if (file.isNull()) {
			this.push(file);
			return cb();
		}

		if (file.isStream()) {
			this.emit('error', new gutil.PluginError(plugin,'Streaming not supported'));
			return cb();
		}

		// Get file contents & paths
		var result = file.contents.toString(),
			base = path.join(file.cwd, src),
			root = file.cwd,
			requireList = [],
			includeBase = include.map((a) => path.join(file.cwd, a)),
			currentPath = path.relative(base, file.base).replace(/\\/g,'/').replace(/^(..*)$/,'$1/'),
			includePath = includeBase.map((a) => path.join(a, currentPath)),
			filename = file.path.replace(file.base,''),
			currentFilename = filename.replace(/\..*/,''),
			currentExtension = filename.replace(/^[^\.]*\./,'.'),
			currentFile = path.join(currentPath,filename).replace(/\\/g,'/'),
			hasPages = _.has(pages,currentFile),
			pageCode = hasPages ? _.map(pages[currentFile],(a,b) => 'var '+b+' = '+JSON.stringify(a)+';').join('') : '';

		// @@if() / @@endif - If statements on global variables
		while(result.match(ifReg) && result.match(endifReg)) {
			var list = result.split(ifSplit);
			for(var i=0,l=list.length;i<l-2;i++) {
				if(list[i].match(ifReg) && list[i+2].match(endifReg)) {
					var testCode = list[i].replace(ifReg,'$1');
					try {
						var passed = eval(globalCode+pageCode+testCode+';');
						if(!passed) {
							list[i+1] = '';
						}
					} catch(e) {
						list[i+1] = '';						
					}
					list[i] = '';
					list[i+2] = '';
				}
			}
			result = list.join('');
		}

		// @@include() - File Includes
		while(result.match(includeReg)) {
			result = result.replace(includeReg,(a,b) => {
				for(var i=0;i<includeLength;i++) {
					var g = glob.sync(includeBase[i]+b);
					if(g.length) return g.map((d) => fs.readFileSync(d).toString()).join('');
				}
				//try current path
				var g = glob.sync(currentPath+b);
				if(g.length) return g.map((d) => fs.readFileSync(d).toString()).join('');

				//none found
				return '';
			});
		}

		// @@require() - File requires
		while(result.match(requireReg)) {
			result = result.replace(requireReg,(a,b) => {
				for(var i=0;i<includeLength;i++) {
					var g = glob.sync(includePath[i]+b);
					if(g.length) {
						var fileList = g.map(path.normalize).filter((c) => (requireList.indexOf(c) == -1));
						requireList = requireList.concat(fileList);
						
						return fileList.map((c) => fs.readFileSync(c).toString()).join('');
					}
				}
				var g = glob.sync(currentPath[i]+b);
				if(g.length) {
					var fileList = g.map(path.normalize).filter((c) => (requireList.indexOf(c) == -1));
					requireList = requireList.concat(fileList);
					return fileList.map((c) => fs.readFileSync(c).toString()).join('');					
				}
				// none found
				return '';
			});
		}
		
		// @@file, @@path and @@ext
		result = replaceString(result,prefix+'path',currentPath);
		result = replaceString(result,prefix+'file',currentFilename);
		result = replaceString(result,prefix+'ext',currentExtension);
		
		// Replace global variables
		_.each(global,(a,b) => {
			result = replaceString(result,prefix+b,a.toString());
		});

		// Replace page-specific variables
		if(_.has(pages,currentFile)) {
			_.each(pages[currentFile],(a,b) => {
				result = replaceString(result,prefix+b,a.toString());
			});
		}	
		
		file.contents = new Buffer(result);

		this.push(file);
		cb();
	});

};
